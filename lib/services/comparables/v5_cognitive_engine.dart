// ═══════════════════════════════════════════════════════════════════════════════
// V5 COGNITIVE ANALYSIS ENGINE
// Advanced Hollywood Intelligence with 3x Deeper Thinking
// ═══════════════════════════════════════════════════════════════════════════════
//
// COGNITIVE LAYERS:
// Layer 1: Surface Analysis (What is the concept?)
// Layer 2: Structural Analysis (How is it constructed?)
// Layer 3: Psychological Analysis (Why does it resonate?)
// Layer 4: Market Intelligence (Who will buy/watch it?)
// Layer 5: Cultural Zeitgeist (Why now?)
// Layer 6: Executive Perspective (How would a studio see this?)
//
// This engine thinks like a combination of:
// - A seasoned development executive
// - A market research analyst
// - A narrative psychologist
// - A cultural critic
// ═══════════════════════════════════════════════════════════════════════════════

// ═══════════════════════════════════════════════════════════════════════════════
// DEEP NARRATIVE DNA - Multi-Layer Character & Story Analysis
// ═══════════════════════════════════════════════════════════════════════════════

class DeepNarrativeDNA {
  // LAYER 1: Core Story Engine
  final String primaryArchetype;
  final String narrativeEngine; // What drives the story forward
  final List<String> genreHybridization; // Genre blend analysis
  
  // LAYER 2: Protagonist Psychology
  final ProtagonistProfile protagonistProfile;
  
  // LAYER 3: Thematic Resonance
  final ThematicAnalysis thematicAnalysis;
  
  // LAYER 4: Structural Mechanics
  final StructuralMechanics structure;
  
  // LAYER 5: Emotional Architecture
  final EmotionalArchitecture emotionalArc;
  
  // LAYER 6: Commercial DNA
  final CommercialDNA commercialDNA;
  
  DeepNarrativeDNA({
    required this.primaryArchetype,
    required this.narrativeEngine,
    required this.genreHybridization,
    required this.protagonistProfile,
    required this.thematicAnalysis,
    required this.structure,
    required this.emotionalArc,
    required this.commercialDNA,
  });
}

// Deep protagonist psychological profile
class ProtagonistProfile {
  final String archetype; // Jung-inspired: Hero, Shadow, Trickster, etc.
  final String psychologicalWound; // What trauma/flaw drives them
  final String desireVsNeed; // Want vs. actual need
  final String transformationArc; // How they change
  final String agency; // Active vs. reactive protagonist
  final String relatability; // Universal connection points
  final List<String> definingTraits;
  final String moralComplexity; // Black/white vs. gray
  final int empathyScore; // 0-100: How much will audiences root for them
  
  ProtagonistProfile({
    required this.archetype,
    required this.psychologicalWound,
    required this.desireVsNeed,
    required this.transformationArc,
    required this.agency,
    required this.relatability,
    required this.definingTraits,
    required this.moralComplexity,
    required this.empathyScore,
  });
}

// Deep thematic analysis
class ThematicAnalysis {
  final String primaryTheme;
  final List<String> secondaryThemes;
  final String universalTruth; // The "so what" - why does this matter
  final String culturalRelevance; // Connection to current moment
  final String timelessElement; // What makes it evergreen
  final int thematicDepth; // 0-100: Surface vs. profound
  final List<String> audienceResonance; // Which groups will connect
  
  ThematicAnalysis({
    required this.primaryTheme,
    required this.secondaryThemes,
    required this.universalTruth,
    required this.culturalRelevance,
    required this.timelessElement,
    required this.thematicDepth,
    required this.audienceResonance,
  });
}

// Structural mechanics analysis
class StructuralMechanics {
  final String structureType; // 3-act, 5-act, episodic, non-linear
  final String hookStrength; // How compelling is the opening premise
  final String escalationPattern; // How stakes build
  final String midpointTurn; // Central reversal potential
  final String climaxPotential; // Satisfying ending potential
  final List<String> setpieces; // Key dramatic moments
  final String pacing; // Fast, measured, slow-burn
  final int structuralIntegrity; // 0-100: How well-constructed
  
  StructuralMechanics({
    required this.structureType,
    required this.hookStrength,
    required this.escalationPattern,
    required this.midpointTurn,
    required this.climaxPotential,
    required this.setpieces,
    required this.pacing,
    required this.structuralIntegrity,
  });
}

// Emotional architecture
class EmotionalArchitecture {
  final String primaryEmotion; // What audiences should feel most
  final List<String> emotionalJourney; // The feeling progression
  final String catharsis; // The emotional payoff
  final int emotionalComplexity; // Simple vs. layered emotional experience
  final String toneConsistency; // Does tone stay coherent
  final List<String> memorableMoments; // What will stick with audiences
  
  EmotionalArchitecture({
    required this.primaryEmotion,
    required this.emotionalJourney,
    required this.catharsis,
    required this.emotionalComplexity,
    required this.toneConsistency,
    required this.memorableMoments,
  });
}

// Commercial DNA analysis
class CommercialDNA {
  final String marketPosition; // Where it sits in the marketplace
  final String audienceQuadrant; // Four quadrant, niche, etc.
  final List<String> marketingHooks; // What sells this
  final String trailerMoment; // The "money shot"
  final int wordOfMouthPotential; // 0-100: Will people talk about it
  final String ancillaryPotential; // Merchandise, sequels, etc.
  final List<String> competitiveAdvantages; // What makes it stand out
  
  CommercialDNA({
    required this.marketPosition,
    required this.audienceQuadrant,
    required this.marketingHooks,
    required this.trailerMoment,
    required this.wordOfMouthPotential,
    required this.ancillaryPotential,
    required this.competitiveAdvantages,
  });
}

// ═══════════════════════════════════════════════════════════════════════════════
// EXECUTIVE PERSPECTIVE - How Hollywood Decision-Makers Would View This
// ═══════════════════════════════════════════════════════════════════════════════

class ExecutivePerspective {
  final String elevatorPitch; // The 30-second sell
  final String comparableFormula; // "X meets Y" distillation
  final List<String> greenFlags; // What execs will love
  final List<String> redFlags; // What might concern them
  final String riskAssessment; // Overall risk profile
  final String budgetSweetSpot; // Optimal budget range
  final String releaseStrategy; // Theatrical, streaming, hybrid
  final String talentAttachment; // Who could package this
  final int passionProjectScore; // Is this a "must make"
  final String studioFit; // Which studios would want this
  final List<String> developmentNotes; // What execs would note
  
  ExecutivePerspective({
    required this.elevatorPitch,
    required this.comparableFormula,
    required this.greenFlags,
    required this.redFlags,
    required this.riskAssessment,
    required this.budgetSweetSpot,
    required this.releaseStrategy,
    required this.talentAttachment,
    required this.passionProjectScore,
    required this.studioFit,
    required this.developmentNotes,
  });
}

// ═══════════════════════════════════════════════════════════════════════════════
// CULTURAL ZEITGEIST ANALYSIS - Why This Matters NOW
// ═══════════════════════════════════════════════════════════════════════════════

class ZeitgeistAnalysis {
  final String culturalMoment; // What's happening in society now
  final List<String> relevantTrends; // Current cultural trends it taps
  final String conversationStarter; // What discussions it could spark
  final String timeliness; // How urgent is this story now
  final int socialRelevance; // 0-100: How connected to current moment
  final String polarizationRisk; // Could this divide audiences
  final List<String> hashtagPotential; // Social media angles
  final String awardsPotential; // Oscar-bait assessment
  
  ZeitgeistAnalysis({
    required this.culturalMoment,
    required this.relevantTrends,
    required this.conversationStarter,
    required this.timeliness,
    required this.socialRelevance,
    required this.polarizationRisk,
    required this.hashtagPotential,
    required this.awardsPotential,
  });
}

// ═══════════════════════════════════════════════════════════════════════════════
// ADVANCED COMPARABLE MATCH - 3x Deeper Analysis
// ═══════════════════════════════════════════════════════════════════════════════

class AdvancedComparableMatch {
  final String title;
  final int year;
  final String platform;
  final String distributor;
  
  // Performance data
  final int? budgetM;
  final int? domesticM;
  final int? worldwideM;
  final double? roi;
  final int? rtScore;
  final int? audienceScore;
  
  // Deep match analysis
  final int overallMatchScore;
  final MatchBreakdown matchBreakdown;
  final String primaryConnection; // Main reason for matching
  final String keyDifferentiator; // What sets your concept apart
  
  // Executive-level insights
  final String marketLesson; // What to learn from this comp
  final String cautionaryNote; // What to avoid
  final String successFactor; // What made this work
  final String applicationInsight; // How to apply this to your project
  
  // Box office intelligence
  final String performanceContext; // Why it performed as it did
  final String audienceReaction; // How audiences responded
  final String legsPotential; // Word of mouth / longevity
  
  AdvancedComparableMatch({
    required this.title,
    required this.year,
    required this.platform,
    required this.distributor,
    this.budgetM,
    this.domesticM,
    this.worldwideM,
    this.roi,
    this.rtScore,
    this.audienceScore,
    required this.overallMatchScore,
    required this.matchBreakdown,
    required this.primaryConnection,
    required this.keyDifferentiator,
    required this.marketLesson,
    required this.cautionaryNote,
    required this.successFactor,
    required this.applicationInsight,
    required this.performanceContext,
    required this.audienceReaction,
    required this.legsPotential,
  });
}

class MatchBreakdown {
  final int narrativeDNA; // Story structure similarity
  final int protagonistMatch; // Character archetype alignment
  final int thematicResonance; // Theme overlap
  final int toneAlignment; // Emotional feel match
  final int marketPosition; // Commercial positioning
  final int audienceOverlap; // Target demo similarity
  final int executionStyle; // Directorial/production approach
  final int culturalMoment; // Zeitgeist alignment
  
  MatchBreakdown({
    required this.narrativeDNA,
    required this.protagonistMatch,
    required this.thematicResonance,
    required this.toneAlignment,
    required this.marketPosition,
    required this.audienceOverlap,
    required this.executionStyle,
    required this.culturalMoment,
  });
  
  int get overall => ((narrativeDNA + protagonistMatch + thematicResonance + 
      toneAlignment + marketPosition + audienceOverlap + executionStyle + 
      culturalMoment) / 8).round();
}

// ═══════════════════════════════════════════════════════════════════════════════
// PRECISION BOX OFFICE FORECAST
// ═══════════════════════════════════════════════════════════════════════════════

class PrecisionForecast {
  // Range predictions
  final int domesticFloor;
  final int domesticCeiling;
  final int domesticMostLikely;
  final int worldwideFloor;
  final int worldwideCeiling;
  final int worldwideMostLikely;
  
  // ROI analysis
  final double pessimisticROI;
  final double optimisticROI;
  final double expectedROI;
  
  // Confidence metrics
  final int confidenceScore;
  final String confidenceLevel;
  final List<String> confidenceFactors;
  
  // Scenario analysis
  final String floorScenario; // What leads to minimum
  final String ceilingScenario; // What leads to maximum
  final String baselineScenario; // Most likely outcome
  
  // Comparable basis
  final List<String> primaryComps;
  final String rationale;
  final List<String> riskFactors;
  final List<String> upsideDrivers;
  
  PrecisionForecast({
    required this.domesticFloor,
    required this.domesticCeiling,
    required this.domesticMostLikely,
    required this.worldwideFloor,
    required this.worldwideCeiling,
    required this.worldwideMostLikely,
    required this.pessimisticROI,
    required this.optimisticROI,
    required this.expectedROI,
    required this.confidenceScore,
    required this.confidenceLevel,
    required this.confidenceFactors,
    required this.floorScenario,
    required this.ceilingScenario,
    required this.baselineScenario,
    required this.primaryComps,
    required this.rationale,
    required this.riskFactors,
    required this.upsideDrivers,
  });
  
  String get domesticRange => '\$${domesticFloor}M - \$${domesticCeiling}M';
  String get worldwideRange => '\$${worldwideFloor}M - \$${worldwideCeiling}M';
  String get mostLikelyDomestic => '\$${domesticMostLikely}M';
  String get mostLikelyWorldwide => '\$${worldwideMostLikely}M';
}

// ═══════════════════════════════════════════════════════════════════════════════
// V5 FULL ANALYSIS RESULT
// ═══════════════════════════════════════════════════════════════════════════════

class V5AnalysisResult {
  final DeepNarrativeDNA narrativeDNA;
  final ExecutivePerspective executivePerspective;
  final ZeitgeistAnalysis zeitgeist;
  final List<AdvancedComparableMatch> topComparables;
  final PrecisionForecast boxOfficeForecast;
  final int overallScore;
  final String verdict;
  final String verdictRationale;
  
  V5AnalysisResult({
    required this.narrativeDNA,
    required this.executivePerspective,
    required this.zeitgeist,
    required this.topComparables,
    required this.boxOfficeForecast,
    required this.overallScore,
    required this.verdict,
    required this.verdictRationale,
  });
}

// ═══════════════════════════════════════════════════════════════════════════════
// V5 COGNITIVE ENGINE - Main Analysis Class
// ═══════════════════════════════════════════════════════════════════════════════

class V5CognitiveEngine {
  static final V5CognitiveEngine _instance = V5CognitiveEngine._internal();
  factory V5CognitiveEngine() => _instance;
  V5CognitiveEngine._internal();
  
  /// Main analysis entry point with 3x deeper thinking
  V5AnalysisResult analyzeDeep({
    required String logline,
    required String genre,
    required String format,
    String? synopsis,
    String? secondaryGenre,
    String? tone,
    String? targetAudience,
    String? budgetTier,
    String? userComparable,
  }) {
    // LAYER 1-6: Deep narrative DNA extraction
    final narrativeDNA = _extractDeepNarrativeDNA(
      logline, genre, format, synopsis, tone, secondaryGenre,
    );
    
    // Executive perspective analysis
    final executivePerspective = _generateExecutivePerspective(
      logline, genre, format, narrativeDNA, budgetTier,
    );
    
    // Cultural zeitgeist analysis
    final zeitgeist = _analyzeZeitgeist(
      logline, genre, narrativeDNA, format,
    );
    
    // Advanced comparable matching
    final comparables = _findAdvancedComparables(
      logline, genre, format, narrativeDNA, tone, budgetTier,
    );
    
    // Precision box office forecast
    final forecast = _generatePrecisionForecast(
      genre, format, budgetTier, comparables, narrativeDNA,
    );
    
    // Calculate overall score
    final overallScore = _calculateOverallScore(
      narrativeDNA, executivePerspective, zeitgeist, comparables,
    );
    
    // Generate verdict
    final verdict = _generateVerdict(overallScore);
    final rationale = _generateVerdictRationale(
      overallScore, narrativeDNA, executivePerspective, zeitgeist,
    );
    
    return V5AnalysisResult(
      narrativeDNA: narrativeDNA,
      executivePerspective: executivePerspective,
      zeitgeist: zeitgeist,
      topComparables: comparables,
      boxOfficeForecast: forecast,
      overallScore: overallScore,
      verdict: verdict,
      verdictRationale: rationale,
    );
  }
  
  // ═══════════════════════════════════════════════════════════════════════════
  // LAYER 1-6: DEEP NARRATIVE DNA EXTRACTION
  // ═══════════════════════════════════════════════════════════════════════════
  
  DeepNarrativeDNA _extractDeepNarrativeDNA(
    String logline, String genre, String format, 
    String? synopsis, String? tone, String? secondaryGenre,
  ) {
    final combined = '${logline.toLowerCase()} ${synopsis?.toLowerCase() ?? ''}';
    
    return DeepNarrativeDNA(
      primaryArchetype: _detectPrimaryArchetype(combined, genre),
      narrativeEngine: _detectNarrativeEngine(combined),
      genreHybridization: _analyzeGenreHybrid(genre, secondaryGenre, combined),
      protagonistProfile: _buildProtagonistProfile(combined, genre),
      thematicAnalysis: _analyzeThemes(combined, genre),
      structure: _analyzeStructure(combined, format),
      emotionalArc: _analyzeEmotionalArc(combined, genre, tone),
      commercialDNA: _analyzeCommercialDNA(combined, genre, format),
    );
  }
  
  String _detectPrimaryArchetype(String text, String genre) {
    // Deep archetype detection with nuanced understanding
    final archetypes = {
      'The Descent into Darkness': ['spiral', 'descent', 'falls into', 'consumed by', 'loses', 'unravel'],
      'The Reluctant Hero\'s Journey': ['must', 'forced to', 'reluctantly', 'unwilling', 'no choice'],
      'The Redemption Arc': ['redemption', 'second chance', 'atone', 'forgive', 'past mistakes'],
      'The Identity Crisis': ['who am i', 'identity', 'discover', 'true self', 'pretending'],
      'The Power Corrupts Tale': ['power', 'corrupt', 'rise', 'empire', 'greed', 'ambition'],
      'The Survival Crucible': ['survive', 'survival', 'escape', 'trapped', 'last', 'only hope'],
      'The Love Against Odds': ['love', 'forbidden', 'romance', 'heart', 'together'],
      'The Truth Seeker': ['uncover', 'truth', 'conspiracy', 'expose', 'hidden', 'secret'],
      'The Underdog Triumph': ['unlikely', 'against all odds', 'nobody', 'underestimate'],
      'The Ticking Clock Crisis': ['before', 'deadline', 'time running out', 'hours', 'must stop'],
      'The Outsider\'s Integration': ['stranger', 'outsider', 'belong', 'acceptance', 'different'],
      'The Master-Apprentice Journey': ['learn', 'mentor', 'train', 'master', 'student'],
      'The Revenge Odyssey': ['revenge', 'vengeance', 'payback', 'hunt', 'kill'],
      'The Family Bonds Test': ['family', 'brother', 'sister', 'father', 'mother', 'child'],
    };
    
    int maxScore = 0;
    String best = 'Character-Driven Drama';
    
    for (final entry in archetypes.entries) {
      int score = 0;
      for (final keyword in entry.value) {
        if (text.contains(keyword)) score += 3;
      }
      if (score > maxScore) {
        maxScore = score;
        best = entry.key;
      }
    }
    
    return best;
  }
  
  String _detectNarrativeEngine(String text) {
    // What drives the story forward
    if (text.contains('must') || text.contains('before') || text.contains('deadline')) {
      return 'Urgency/Time Pressure';
    }
    if (text.contains('discover') || text.contains('uncover') || text.contains('secret')) {
      return 'Mystery/Revelation';
    }
    if (text.contains('survive') || text.contains('escape') || text.contains('hunt')) {
      return 'Survival/Pursuit';
    }
    if (text.contains('love') || text.contains('relationship') || text.contains('heart')) {
      return 'Emotional Connection';
    }
    if (text.contains('revenge') || text.contains('justice') || text.contains('wrong')) {
      return 'Vengeance/Justice';
    }
    if (text.contains('power') || text.contains('control') || text.contains('empire')) {
      return 'Ambition/Power';
    }
    if (text.contains('transform') || text.contains('become') || text.contains('change')) {
      return 'Personal Transformation';
    }
    return 'Character Evolution';
  }
  
  List<String> _analyzeGenreHybrid(String primary, String? secondary, String text) {
    final hybridElements = <String>[];
    hybridElements.add(primary);
    if (secondary != null && secondary.isNotEmpty) hybridElements.add(secondary);
    
    // Detect hidden genre elements
    if (text.contains('romance') || text.contains('love')) hybridElements.add('Romance undertones');
    if (text.contains('laugh') || text.contains('comedy') || text.contains('humor')) hybridElements.add('Comic elements');
    if (text.contains('politic') || text.contains('power') || text.contains('corrupt')) hybridElements.add('Political thriller');
    if (text.contains('family') || text.contains('father') || text.contains('mother')) hybridElements.add('Family drama');
    
    return hybridElements.toSet().toList();
  }
  
  ProtagonistProfile _buildProtagonistProfile(String text, String genre) {
    // Detect psychological wound
    String wound = 'Undefined trauma';
    if (text.contains('loss') || text.contains('death') || text.contains('died')) {
      wound = 'Grief and loss';
    } else if (text.contains('betray') || text.contains('trust')) {
      wound = 'Betrayal trauma';
    } else if (text.contains('abandon') || text.contains('alone')) {
      wound = 'Abandonment issues';
    } else if (text.contains('guilt') || text.contains('mistake')) {
      wound = 'Survivor\'s guilt';
    } else if (text.contains('failure') || text.contains('failed')) {
      wound = 'Fear of failure';
    }
    
    // Detect desire vs need
    String desireNeed = 'External goal with internal need';
    if (text.contains('revenge') || text.contains('vengeance')) {
      desireNeed = 'Wants revenge, needs peace';
    } else if (text.contains('love') || text.contains('romance')) {
      desireNeed = 'Wants connection, needs self-acceptance';
    } else if (text.contains('power') || text.contains('success')) {
      desireNeed = 'Wants power, needs meaning';
    } else if (text.contains('survive')) {
      desireNeed = 'Wants survival, needs to live fully';
    }
    
    // Detect archetype
    String archetype = 'The Everyman';
    if (text.contains('chosen') || text.contains('special') || text.contains('gift')) {
      archetype = 'The Chosen One';
    } else if (text.contains('detective') || text.contains('investigate') || text.contains('agent')) {
      archetype = 'The Seeker';
    } else if (text.contains('criminal') || text.contains('thief') || text.contains('dark')) {
      archetype = 'The Antihero';
    } else if (text.contains('mentor') || text.contains('teacher') || text.contains('guide')) {
      archetype = 'The Sage';
    } else if (text.contains('rebel') || text.contains('outlaw') || text.contains('against')) {
      archetype = 'The Rebel';
    } else if (text.contains('protect') || text.contains('save') || text.contains('family')) {
      archetype = 'The Protector';
    }
    
    // Agency detection
    String agency = 'Reactive protagonist';
    if (text.contains('decides') || text.contains('chooses') || text.contains('sets out')) {
      agency = 'Active protagonist';
    }
    
    // Transformation arc
    String arc = 'Positive change arc';
    if (text.contains('corrupt') || text.contains('become villain') || text.contains('descent')) {
      arc = 'Corruption arc';
    } else if (text.contains('maintain') || text.contains('prove') || text.contains('tested')) {
      arc = 'Flat/testing arc';
    }
    
    // Empathy score calculation
    int empathy = 60;
    if (text.contains('family') || text.contains('child') || text.contains('protect')) empathy += 15;
    if (text.contains('underdog') || text.contains('unlikely') || text.contains('ordinary')) empathy += 10;
    if (text.contains('sacrifice') || text.contains('selfless')) empathy += 10;
    if (text.contains('villain') || text.contains('criminal') || text.contains('murder')) empathy -= 10;
    
    return ProtagonistProfile(
      archetype: archetype,
      psychologicalWound: wound,
      desireVsNeed: desireNeed,
      transformationArc: arc,
      agency: agency,
      relatability: empathy > 70 ? 'Highly relatable' : empathy > 50 ? 'Moderately relatable' : 'Challenging protagonist',
      definingTraits: _extractDefiningTraits(text),
      moralComplexity: text.contains('moral') || text.contains('gray') || text.contains('question') 
          ? 'Morally complex' : 'Clear moral compass',
      empathyScore: empathy.clamp(30, 95),
    );
  }
  
  List<String> _extractDefiningTraits(String text) {
    final traits = <String>[];
    final traitMap = {
      'Determined': ['must', 'will', 'refuses to', 'determined'],
      'Intelligent': ['brilliant', 'genius', 'clever', 'smart'],
      'Wounded': ['haunted', 'trauma', 'past', 'demons'],
      'Charismatic': ['charm', 'charisma', 'leader'],
      'Broken': ['broken', 'lost', 'fallen', 'destroyed'],
      'Resourceful': ['resourceful', 'survive', 'adapt', 'clever'],
      'Loyal': ['loyal', 'friend', 'protect', 'family'],
      'Obsessed': ['obsess', 'consume', 'driven', 'relentless'],
    };
    
    for (final entry in traitMap.entries) {
      for (final keyword in entry.value) {
        if (text.contains(keyword)) {
          traits.add(entry.key);
          break;
        }
      }
    }
    
    return traits.isEmpty ? ['Complex', 'Multi-dimensional'] : traits.take(4).toList();
  }
  
  ThematicAnalysis _analyzeThemes(String text, String genre) {
    // Deep thematic extraction
    String primary = 'Self-discovery';
    final secondary = <String>[];
    
    final themeMap = {
      'Identity and Self': ['identity', 'who am i', 'true self', 'mask'],
      'Family Bonds': ['family', 'father', 'mother', 'parent', 'child'],
      'Power and Corruption': ['power', 'corrupt', 'control', 'empire'],
      'Love and Connection': ['love', 'romance', 'heart', 'relationship'],
      'Survival and Resilience': ['survive', 'endure', 'overcome'],
      'Justice vs Vengeance': ['justice', 'revenge', 'vengeance', 'wrong'],
      'Truth and Deception': ['truth', 'lie', 'deceive', 'secret'],
      'Legacy and Memory': ['legacy', 'remember', 'memory', 'history'],
      'Morality and Choice': ['choice', 'moral', 'decide', 'right', 'wrong'],
      'Loss and Grief': ['loss', 'grief', 'death', 'mourn'],
      'Redemption': ['redemption', 'forgive', 'second chance', 'atone'],
      'Freedom vs Control': ['freedom', 'escape', 'control', 'trap'],
      'Class and Society': ['class', 'rich', 'poor', 'society', 'wealth'],
      'Technology and Humanity': ['ai', 'technology', 'machine', 'human'],
    };
    
    int maxScore = 0;
    for (final entry in themeMap.entries) {
      int score = 0;
      for (final keyword in entry.value) {
        if (text.contains(keyword)) score++;
      }
      if (score > maxScore) {
        maxScore = score;
        primary = entry.key;
      } else if (score > 0) {
        secondary.add(entry.key);
      }
    }
    
    // Universal truth
    String universalTruth = 'The search for meaning in a complex world';
    if (primary.contains('Family')) universalTruth = 'Family bonds transcend all obstacles';
    if (primary.contains('Power')) universalTruth = 'Power reveals true character';
    if (primary.contains('Love')) universalTruth = 'Love transforms and heals';
    if (primary.contains('Identity')) universalTruth = 'True identity must be discovered, not inherited';
    if (primary.contains('Justice')) universalTruth = 'Justice and revenge are not the same';
    
    // Cultural relevance
    String cultural = 'Timeless human concern';
    if (text.contains('ai') || text.contains('technology') || text.contains('digital')) {
      cultural = 'Speaks to digital age anxieties';
    }
    if (text.contains('climate') || text.contains('environment')) {
      cultural = 'Environmental consciousness';
    }
    if (text.contains('class') || text.contains('wealth') || text.contains('inequality')) {
      cultural = 'Wealth inequality discourse';
    }
    if (text.contains('gender') || text.contains('female') || text.contains('woman')) {
      cultural = 'Gender dynamics conversation';
    }
    
    return ThematicAnalysis(
      primaryTheme: primary,
      secondaryThemes: secondary.take(3).toList(),
      universalTruth: universalTruth,
      culturalRelevance: cultural,
      timelessElement: 'Human desire for connection and meaning',
      thematicDepth: (maxScore * 15).clamp(45, 95),
      audienceResonance: _determineAudienceResonance(primary, secondary),
    );
  }
  
  List<String> _determineAudienceResonance(String primary, List<String> secondary) {
    final resonance = <String>[];
    
    if (primary.contains('Family') || secondary.any((s) => s.contains('Family'))) {
      resonance.add('Parents');
      resonance.add('Family audiences');
    }
    if (primary.contains('Love') || secondary.any((s) => s.contains('Love'))) {
      resonance.add('Romantics');
      resonance.add('Date night audiences');
    }
    if (primary.contains('Power') || primary.contains('Justice')) {
      resonance.add('Political awareness');
      resonance.add('Socially conscious viewers');
    }
    if (primary.contains('Identity')) {
      resonance.add('Young adults');
      resonance.add('Coming-of-age seekers');
    }
    
    if (resonance.isEmpty) resonance.addAll(['General audiences', 'Genre enthusiasts']);
    
    return resonance;
  }
  
  StructuralMechanics _analyzeStructure(String text, String format) {
    // Hook strength
    String hookStrength = 'Standard hook';
    int hookScore = 60;
    
    if (text.contains('when') && text.contains('must')) {
      hookStrength = 'Strong inciting incident';
      hookScore = 80;
    }
    if (text.contains('discover') || text.contains('learn')) {
      hookStrength = 'Mystery-driven hook';
      hookScore = 75;
    }
    if (text.contains('only') || text.contains('last')) {
      hookStrength = 'High-stakes hook';
      hookScore = 85;
    }
    
    // Escalation pattern
    String escalation = 'Linear escalation';
    if (text.contains('twist') || text.contains('reveal')) {
      escalation = 'Revelation-based escalation';
    }
    if (text.contains('race') || text.contains('time')) {
      escalation = 'Countdown escalation';
    }
    
    // Structure type
    String structureType = '3-Act Structure';
    if (format.toLowerCase().contains('series')) {
      structureType = 'Episodic/Serial';
    }
    if (text.contains('parallel') || text.contains('multiple')) {
      structureType = 'Multi-threaded narrative';
    }
    
    // Setpieces
    final setpieces = <String>[];
    if (text.contains('confront')) setpieces.add('Climactic confrontation');
    if (text.contains('escape')) setpieces.add('Escape sequence');
    if (text.contains('reveal') || text.contains('truth')) setpieces.add('Major revelation');
    if (text.contains('battle') || text.contains('fight')) setpieces.add('Action set piece');
    if (text.contains('sacrifice')) setpieces.add('Sacrifice moment');
    
    return StructuralMechanics(
      structureType: structureType,
      hookStrength: hookStrength,
      escalationPattern: escalation,
      midpointTurn: 'Central reversal expected',
      climaxPotential: hookScore > 75 ? 'Strong climax potential' : 'Moderate climax potential',
      setpieces: setpieces.isEmpty ? ['Character-driven moments'] : setpieces,
      pacing: format.toLowerCase().contains('series') ? 'Episodic pacing' : 'Feature pacing',
      structuralIntegrity: hookScore,
    );
  }
  
  EmotionalArchitecture _analyzeEmotionalArc(String text, String genre, String? tone) {
    // Primary emotion from genre
    final genreEmotions = {
      'Horror': 'Fear and dread',
      'Thriller': 'Tension and suspense',
      'Drama': 'Empathy and catharsis',
      'Comedy': 'Joy and amusement',
      'Romance': 'Longing and fulfillment',
      'Action': 'Excitement and thrill',
      'Sci-Fi': 'Wonder and curiosity',
    };
    
    String primary = genreEmotions[genre] ?? 'Emotional engagement';
    
    // Emotional journey
    final journey = <String>['Opening intrigue'];
    if (text.contains('tension') || text.contains('danger')) journey.add('Building anxiety');
    if (text.contains('hope') || text.contains('love')) journey.add('Moments of hope');
    if (text.contains('loss') || text.contains('fail')) journey.add('Devastating low point');
    if (text.contains('triumph') || text.contains('succeed')) journey.add('Triumphant resolution');
    journey.add('Emotional payoff');
    
    // Catharsis type
    String catharsis = 'Satisfying resolution';
    if (text.contains('bitter') || text.contains('cost')) {
      catharsis = 'Bittersweet catharsis';
    }
    if (text.contains('triumph') || text.contains('victory')) {
      catharsis = 'Triumphant catharsis';
    }
    if (text.contains('tragedy') || text.contains('death')) {
      catharsis = 'Tragic catharsis';
    }
    
    return EmotionalArchitecture(
      primaryEmotion: primary,
      emotionalJourney: journey,
      catharsis: catharsis,
      emotionalComplexity: journey.length > 4 ? 85 : 65,
      toneConsistency: tone != null ? 'Consistent $tone tone' : 'Varied emotional tones',
      memorableMoments: _detectMemorableMoments(text),
    );
  }
  
  List<String> _detectMemorableMoments(String text) {
    final moments = <String>[];
    
    if (text.contains('twist') || text.contains('reveal')) moments.add('Major plot twist');
    if (text.contains('sacrifice')) moments.add('Sacrificial moment');
    if (text.contains('confront')) moments.add('Final confrontation');
    if (text.contains('love') || text.contains('kiss')) moments.add('Romantic peak');
    if (text.contains('death') || text.contains('kill')) moments.add('Shocking death');
    if (text.contains('escape')) moments.add('Thrilling escape');
    
    return moments.isEmpty ? ['Character-defining moment'] : moments;
  }
  
  CommercialDNA _analyzeCommercialDNA(String text, String genre, String format) {
    // Market position
    String marketPos = 'Mid-market positioning';
    if (text.contains('epic') || text.contains('massive') || text.contains('world')) {
      marketPos = 'Tentpole positioning';
    }
    if (text.contains('intimate') || text.contains('personal') || text.contains('quiet')) {
      marketPos = 'Prestige/indie positioning';
    }
    
    // Audience quadrant
    String quadrant = 'General audiences';
    if (genre == 'Horror' || genre == 'Action') {
      quadrant = 'Male-skewing';
    }
    if (genre == 'Romance' || genre == 'Drama') {
      quadrant = 'Female-skewing';
    }
    if (text.contains('family') || text.contains('adventure')) {
      quadrant = 'Four quadrant';
    }
    
    // Marketing hooks
    final hooks = <String>[];
    if (text.contains('true story') || text.contains('based on')) hooks.add('True story angle');
    if (text.contains('twist')) hooks.add('Twist marketing');
    if (text.contains('visual') || text.contains('world')) hooks.add('Visual spectacle');
    hooks.add('Genre-specific marketing');
    
    // Word of mouth potential
    int womPotential = 60;
    if (text.contains('twist') || text.contains('ending')) womPotential += 15;
    if (text.contains('emotional') || text.contains('cry')) womPotential += 10;
    if (text.contains('thought') || text.contains('question')) womPotential += 10;
    
    return CommercialDNA(
      marketPosition: marketPos,
      audienceQuadrant: quadrant,
      marketingHooks: hooks,
      trailerMoment: 'Key dramatic reveal',
      wordOfMouthPotential: womPotential.clamp(40, 95),
      ancillaryPotential: format.contains('Series') ? 'Streaming franchise potential' : 'Sequel potential',
      competitiveAdvantages: _identifyAdvantages(text, genre),
    );
  }
  
  List<String> _identifyAdvantages(String text, String genre) {
    final advantages = <String>[];
    
    if (text.contains('unique') || text.contains('never')) advantages.add('Fresh concept');
    if (text.contains('true') || text.contains('real')) advantages.add('True story credibility');
    if (text.contains('timely') || text.contains('now')) advantages.add('Cultural timeliness');
    
    advantages.add('Genre execution');
    
    return advantages;
  }
  
  // ═══════════════════════════════════════════════════════════════════════════
  // EXECUTIVE PERSPECTIVE GENERATION
  // ═══════════════════════════════════════════════════════════════════════════
  
  ExecutivePerspective _generateExecutivePerspective(
    String logline, String genre, String format,
    DeepNarrativeDNA dna, String? budgetTier,
  ) {
    // Generate elevator pitch
    final elevator = _generateElevatorPitch(logline, genre, dna);
    
    // Green flags
    final greenFlags = <String>[];
    if (dna.protagonistProfile.empathyScore > 70) greenFlags.add('Strong protagonist empathy');
    if (dna.thematicAnalysis.thematicDepth > 70) greenFlags.add('Thematic resonance');
    if (dna.structure.structuralIntegrity > 75) greenFlags.add('Solid narrative structure');
    if (dna.commercialDNA.wordOfMouthPotential > 70) greenFlags.add('Word-of-mouth potential');
    if (dna.genreHybridization.length > 2) greenFlags.add('Genre-blending appeal');
    
    // Red flags
    final redFlags = <String>[];
    if (dna.protagonistProfile.empathyScore < 50) redFlags.add('Protagonist likability concerns');
    if (dna.structure.structuralIntegrity < 60) redFlags.add('Narrative clarity issues');
    if (dna.thematicAnalysis.thematicDepth < 50) redFlags.add('Thematic depth questions');
    
    // Budget sweet spot
    String budgetSweet = '\$30M - \$60M';
    if (dna.commercialDNA.marketPosition.contains('Tentpole')) {
      budgetSweet = '\$100M - \$200M';
    } else if (dna.commercialDNA.marketPosition.contains('indie')) {
      budgetSweet = '\$5M - \$20M';
    }
    
    // Studio fit
    String studioFit = 'Wide appeal';
    if (genre == 'Horror') studioFit = 'Blumhouse, A24, Neon';
    if (genre == 'Drama') studioFit = 'A24, Searchlight, Focus Features';
    if (dna.commercialDNA.marketPosition.contains('Tentpole')) {
      studioFit = 'Major studios (Universal, Warner Bros, Disney)';
    }
    
    // Development notes
    final devNotes = <String>[];
    devNotes.add('Clarify protagonist\'s internal journey');
    devNotes.add('Strengthen act two complications');
    if (redFlags.isNotEmpty) devNotes.add('Address ${redFlags.first.toLowerCase()}');
    devNotes.add('Ensure climax delivers on thematic promise');
    
    return ExecutivePerspective(
      elevatorPitch: elevator,
      comparableFormula: _generateCompFormula(genre, dna),
      greenFlags: greenFlags.isEmpty ? ['Compelling concept'] : greenFlags,
      redFlags: redFlags.isEmpty ? ['None significant'] : redFlags,
      riskAssessment: redFlags.length > 2 ? 'Higher risk' : redFlags.isEmpty ? 'Lower risk' : 'Moderate risk',
      budgetSweetSpot: budgetSweet,
      releaseStrategy: format.contains('Series') ? 'Premium streaming' : 'Theatrical release',
      talentAttachment: 'A-list attachment recommended',
      passionProjectScore: dna.thematicAnalysis.thematicDepth,
      studioFit: studioFit,
      developmentNotes: devNotes,
    );
  }
  
  String _generateElevatorPitch(String logline, String genre, DeepNarrativeDNA dna) {
    return 'A ${genre.toLowerCase()} that explores ${dna.thematicAnalysis.primaryTheme.toLowerCase()} '
        'through the lens of ${dna.primaryArchetype.toLowerCase()}. '
        '${dna.narrativeEngine} drives a ${dna.emotionalArc.primaryEmotion.toLowerCase()} experience '
        'with ${dna.commercialDNA.audienceQuadrant.toLowerCase()} appeal.';
  }
  
  String _generateCompFormula(String genre, DeepNarrativeDNA dna) {
    final compTitles = {
      'Horror': ['Get Out', 'A Quiet Place', 'Hereditary'],
      'Thriller': ['Gone Girl', 'Knives Out', 'Parasite'],
      'Drama': ['The Holdovers', 'Past Lives', 'Marriage Story'],
      'Action': ['John Wick', 'Top Gun: Maverick', 'Mission: Impossible'],
      'Sci-Fi': ['Dune', 'Everything Everywhere', 'Arrival'],
      'Comedy': ['Barbie', 'The Menu', 'Bodies Bodies Bodies'],
      'Romance': ['Anyone But You', 'Crazy Rich Asians', 'La La Land'],
    };
    
    final titles = compTitles[genre] ?? ['Original concept'];
    return '${titles[0]} meets ${titles.length > 1 ? titles[1] : 'fresh perspective'}';
  }
  
  // ═══════════════════════════════════════════════════════════════════════════
  // ZEITGEIST ANALYSIS
  // ═══════════════════════════════════════════════════════════════════════════
  
  ZeitgeistAnalysis _analyzeZeitgeist(
    String logline, String genre, DeepNarrativeDNA dna, String format,
  ) {
    final text = logline.toLowerCase();
    
    // Cultural moment detection
    String cultural = 'Evergreen human story';
    if (text.contains('ai') || text.contains('technology') || text.contains('algorithm')) {
      cultural = 'AI/Tech anxiety era';
    }
    if (text.contains('climate') || text.contains('environment') || text.contains('planet')) {
      cultural = 'Climate consciousness moment';
    }
    if (text.contains('class') || text.contains('wealth') || text.contains('rich')) {
      cultural = 'Economic inequality discourse';
    }
    if (text.contains('gender') || text.contains('woman') || text.contains('power')) {
      cultural = 'Gender dynamics conversation';
    }
    if (text.contains('politic') || text.contains('divided') || text.contains('system')) {
      cultural = 'Political polarization era';
    }
    
    // Relevant trends
    final trends = <String>[];
    trends.add('Genre revival interest');
    if (dna.thematicAnalysis.culturalRelevance.contains('digital')) {
      trends.add('Tech skepticism');
    }
    if (dna.commercialDNA.audienceQuadrant.contains('Female')) {
      trends.add('Female-led storytelling demand');
    }
    trends.add('Elevated genre appreciation');
    
    // Conversation starter
    String conversation = 'Character-driven discussions';
    if (dna.thematicAnalysis.primaryTheme.contains('Power')) {
      conversation = 'Power structures in society';
    }
    if (dna.thematicAnalysis.primaryTheme.contains('Identity')) {
      conversation = 'Identity and authenticity';
    }
    if (dna.thematicAnalysis.primaryTheme.contains('Family')) {
      conversation = 'Modern family dynamics';
    }
    
    // Social relevance score
    int relevance = 60;
    if (cultural != 'Evergreen human story') relevance += 20;
    if (trends.length > 2) relevance += 10;
    
    // Awards potential
    String awards = 'Genre recognition potential';
    if (genre == 'Drama') awards = 'Strong Oscar potential';
    if (dna.thematicAnalysis.thematicDepth > 80) awards = 'Awards contender';
    
    return ZeitgeistAnalysis(
      culturalMoment: cultural,
      relevantTrends: trends,
      conversationStarter: conversation,
      timeliness: relevance > 70 ? 'Highly timely' : 'Moderately timely',
      socialRelevance: relevance.clamp(40, 95),
      polarizationRisk: text.contains('politic') || text.contains('religion') ? 'Some polarization risk' : 'Low polarization risk',
      hashtagPotential: _generateHashtags(genre, dna),
      awardsPotential: awards,
    );
  }
  
  List<String> _generateHashtags(String genre, DeepNarrativeDNA dna) {
    final hashtags = <String>[];
    hashtags.add('#MustSee$genre');
    if (dna.commercialDNA.wordOfMouthPotential > 70) {
      hashtags.add('#MovieOfTheYear');
    }
    hashtags.add('#${genre}Film');
    return hashtags;
  }
  
  // ═══════════════════════════════════════════════════════════════════════════
  // ADVANCED COMPARABLE MATCHING
  // ═══════════════════════════════════════════════════════════════════════════
  
  List<AdvancedComparableMatch> _findAdvancedComparables(
    String logline, String genre, String format,
    DeepNarrativeDNA dna, String? tone, String? budgetTier,
  ) {
    final database = _getAdvancedDatabase();
    final matches = <AdvancedComparableMatch>[];
    
    for (final comp in database) {
      final breakdown = _calculateAdvancedMatch(dna, comp, genre, tone);
      
      if (breakdown.overall >= 35) {
        matches.add(AdvancedComparableMatch(
          title: comp.title,
          year: comp.year,
          platform: comp.platform,
          distributor: comp.distributor,
          budgetM: comp.budgetM,
          domesticM: comp.domesticM,
          worldwideM: comp.worldwideM,
          roi: comp.roi,
          rtScore: comp.rtScore,
          audienceScore: comp.audienceScore,
          overallMatchScore: breakdown.overall,
          matchBreakdown: breakdown,
          primaryConnection: _generatePrimaryConnection(breakdown, comp, dna),
          keyDifferentiator: _generateDifferentiator(dna, comp),
          marketLesson: comp.marketLesson,
          cautionaryNote: comp.cautionaryNote,
          successFactor: comp.successFactor,
          applicationInsight: _generateApplicationInsight(comp, dna),
          performanceContext: comp.performanceContext,
          audienceReaction: comp.audienceReaction,
          legsPotential: comp.legsPotential,
        ));
      }
    }
    
    matches.sort((a, b) => b.overallMatchScore.compareTo(a.overallMatchScore));
    return matches.take(5).toList();
  }
  
  MatchBreakdown _calculateAdvancedMatch(
    DeepNarrativeDNA concept, _CompEntry comp, String genre, String? tone,
  ) {
    // Narrative DNA match
    int narrativeDNA = 40;
    if (concept.primaryArchetype == comp.archetype) narrativeDNA += 40;
    else if (_areArchetypesRelated(concept.primaryArchetype, comp.archetype)) narrativeDNA += 20;
    if (concept.narrativeEngine == comp.engine) narrativeDNA += 20;
    
    // Protagonist match
    int protagonistMatch = 40;
    if (concept.protagonistProfile.archetype == comp.protagonistType) protagonistMatch += 35;
    if (concept.protagonistProfile.transformationArc.contains(comp.arc)) protagonistMatch += 25;
    
    // Thematic resonance
    int thematicResonance = 35;
    if (concept.thematicAnalysis.primaryTheme.contains(comp.theme) || 
        comp.theme.contains(concept.thematicAnalysis.primaryTheme.split(' ').first)) {
      thematicResonance += 40;
    }
    for (final secondary in concept.thematicAnalysis.secondaryThemes) {
      if (comp.themes.any((t) => t.contains(secondary) || secondary.contains(t))) {
        thematicResonance += 10;
        break;
      }
    }
    
    // Tone alignment
    int toneAlignment = 40;
    if (tone != null && comp.tones.any((t) => t.toLowerCase() == tone.toLowerCase())) {
      toneAlignment += 40;
    }
    if (concept.emotionalArc.primaryEmotion.toLowerCase().contains(comp.primaryEmotion.toLowerCase())) {
      toneAlignment += 20;
    }
    
    // Market position
    int marketPosition = 40;
    if (genre == comp.genre) marketPosition += 30;
    if (concept.commercialDNA.marketPosition.contains(comp.marketTier)) marketPosition += 20;
    
    // Audience overlap
    int audienceOverlap = 40;
    if (concept.commercialDNA.audienceQuadrant == comp.quadrant) audienceOverlap += 40;
    else if (concept.commercialDNA.audienceQuadrant.contains('Four') || 
             comp.quadrant.contains('Four')) audienceOverlap += 20;
    
    // Execution style
    int executionStyle = 45;
    if (concept.structure.pacing == comp.pacing) executionStyle += 25;
    
    // Cultural moment
    int culturalMoment = 45;
    if (comp.year >= 2022) culturalMoment += 25;
    
    return MatchBreakdown(
      narrativeDNA: narrativeDNA.clamp(0, 100),
      protagonistMatch: protagonistMatch.clamp(0, 100),
      thematicResonance: thematicResonance.clamp(0, 100),
      toneAlignment: toneAlignment.clamp(0, 100),
      marketPosition: marketPosition.clamp(0, 100),
      audienceOverlap: audienceOverlap.clamp(0, 100),
      executionStyle: executionStyle.clamp(0, 100),
      culturalMoment: culturalMoment.clamp(0, 100),
    );
  }
  
  bool _areArchetypesRelated(String a, String b) {
    final groups = [
      {'The Descent into Darkness', 'The Power Corrupts Tale', 'The Fall'},
      {'The Reluctant Hero\'s Journey', 'The Underdog Triumph', 'Hero Journey'},
      {'The Redemption Arc', 'The Identity Crisis', 'Transformation'},
      {'The Truth Seeker', 'The Mystery', 'Investigation'},
      {'The Survival Crucible', 'The Ticking Clock Crisis', 'Survival'},
    ];
    return groups.any((g) => 
      g.any((e) => a.contains(e) || e.contains(a)) && 
      g.any((e) => b.contains(e) || e.contains(b))
    );
  }
  
  String _generatePrimaryConnection(MatchBreakdown breakdown, _CompEntry comp, DeepNarrativeDNA dna) {
    if (breakdown.narrativeDNA >= 70) {
      return 'Shares "${dna.primaryArchetype}" narrative DNA with ${comp.title}';
    }
    if (breakdown.thematicResonance >= 70) {
      return 'Explores similar ${dna.thematicAnalysis.primaryTheme.toLowerCase()} themes';
    }
    if (breakdown.protagonistMatch >= 70) {
      return 'Similar protagonist journey and character arc';
    }
    if (breakdown.toneAlignment >= 70) {
      return 'Matches ${comp.title}\'s emotional tone and feel';
    }
    return 'Strong overall genre and market alignment';
  }
  
  String _generateDifferentiator(DeepNarrativeDNA dna, _CompEntry comp) {
    final diffs = <String>[];
    
    if (dna.thematicAnalysis.culturalRelevance != 'Timeless human concern') {
      diffs.add('your ${dna.thematicAnalysis.culturalRelevance.toLowerCase()}');
    }
    if (dna.protagonistProfile.psychologicalWound != 'Undefined trauma') {
      diffs.add('unique protagonist wound');
    }
    if (dna.genreHybridization.length > 2) {
      diffs.add('fresh genre blend');
    }
    
    if (diffs.isEmpty) return 'Your fresh contemporary perspective';
    return 'Your concept stands apart with ${diffs.first}';
  }
  
  String _generateApplicationInsight(_CompEntry comp, DeepNarrativeDNA dna) {
    if (comp.roi != null && comp.roi! > 5) {
      return 'Like ${comp.title}, lean into distinctive voice over budget';
    }
    if (comp.rtScore != null && comp.rtScore! > 90) {
      return 'Critical acclaim drove ${comp.title}\'s success—prioritize execution quality';
    }
    if (comp.audienceScore != null && comp.audienceScore! > comp.rtScore!) {
      return '${comp.title} proved audiences value emotional satisfaction over critical approval';
    }
    return 'Study ${comp.title}\'s marketing campaign for positioning guidance';
  }
  
  // ═══════════════════════════════════════════════════════════════════════════
  // PRECISION FORECAST
  // ═══════════════════════════════════════════════════════════════════════════
  
  PrecisionForecast _generatePrecisionForecast(
    String genre, String format, String? budgetTier,
    List<AdvancedComparableMatch> comps, DeepNarrativeDNA dna,
  ) {
    if (comps.isEmpty) {
      return _getBaselineForecast(genre, format, budgetTier);
    }
    
    // Weight by match score (squared for emphasis)
    double totalWeight = 0;
    double weightedDomestic = 0;
    double weightedWorldwide = 0;
    double weightedROI = 0;
    
    final validComps = comps.where((c) => c.domesticM != null && c.worldwideM != null).toList();
    final compTitles = <String>[];
    
    for (final comp in validComps) {
      final weight = (comp.overallMatchScore / 100) * (comp.overallMatchScore / 100);
      totalWeight += weight;
      weightedDomestic += (comp.domesticM ?? 50) * weight;
      weightedWorldwide += (comp.worldwideM ?? 100) * weight;
      weightedROI += (comp.roi ?? 2.0) * weight;
      compTitles.add('${comp.title} (${comp.year})');
    }
    
    if (totalWeight == 0) return _getBaselineForecast(genre, format, budgetTier);
    
    final avgDom = (weightedDomestic / totalWeight).round();
    final avgWW = (weightedWorldwide / totalWeight).round();
    final avgROI = weightedROI / totalWeight;
    
    // Budget adjustment
    final budgetMult = _getBudgetMult(budgetTier);
    
    // Variance based on comps
    final variance = _calcVariance(validComps.map((c) => c.domesticM!).toList());
    
    // Confidence calculation
    final avgMatch = comps.map((c) => c.overallMatchScore).reduce((a, b) => a + b) / comps.length;
    int confidence = ((validComps.length * 15) + (avgMatch * 0.5)).round().clamp(30, 95);
    
    // Risk factors
    final risks = <String>[];
    if (avgMatch < 60) risks.add('Limited comparable precedent');
    if (validComps.length < 3) risks.add('Small sample size');
    if (dna.commercialDNA.wordOfMouthPotential < 60) risks.add('Word-of-mouth concerns');
    
    // Upside drivers
    final upside = <String>[];
    if (dna.protagonistProfile.empathyScore > 75) upside.add('Strong audience connection');
    if (dna.commercialDNA.wordOfMouthPotential > 75) upside.add('Viral potential');
    if (avgROI > 4) upside.add('High-ROI genre space');
    
    return PrecisionForecast(
      domesticFloor: (avgDom * 0.5 * budgetMult).round(),
      domesticCeiling: (avgDom * 1.6 * budgetMult).round(),
      domesticMostLikely: (avgDom * budgetMult).round(),
      worldwideFloor: (avgWW * 0.5 * budgetMult).round(),
      worldwideCeiling: (avgWW * 1.6 * budgetMult).round(),
      worldwideMostLikely: (avgWW * budgetMult).round(),
      pessimisticROI: avgROI * 0.5,
      optimisticROI: avgROI * 1.8,
      expectedROI: avgROI,
      confidenceScore: confidence,
      confidenceLevel: confidence >= 75 ? 'High' : confidence >= 50 ? 'Medium' : 'Low',
      confidenceFactors: [
        '${validComps.length} semantically-matched comparables',
        '${avgMatch.round()}% average match score',
        'Genre performance data',
      ],
      floorScenario: 'Limited marketing, crowded release, mixed reviews',
      ceilingScenario: 'Strong reviews, clear positioning, awards buzz',
      baselineScenario: 'Solid execution with standard marketing support',
      primaryComps: compTitles.take(3).toList(),
      rationale: 'Weighted average of ${validComps.length} semantically-matched titles, '
          'adjusted for narrative DNA alignment (${avgMatch.round()}% avg match)',
      riskFactors: risks.isEmpty ? ['Standard market risks'] : risks,
      upsideDrivers: upside.isEmpty ? ['Quality execution'] : upside,
    );
  }
  
  double _getBudgetMult(String? tier) {
    switch (tier?.toLowerCase()) {
      case 'micro': return 0.3;
      case 'low': return 0.6;
      case 'medium': return 1.0;
      case 'high': return 1.8;
      case 'blockbuster': return 3.0;
      default: return 1.0;
    }
  }
  
  double _calcVariance(List<int> values) {
    if (values.length < 2) return 0.4;
    final avg = values.reduce((a, b) => a + b) / values.length;
    if (avg == 0) return 0.4;
    return values.map((v) => (v - avg).abs() / avg).reduce((a, b) => a + b) / values.length;
  }
  
  PrecisionForecast _getBaselineForecast(String genre, String format, String? budgetTier) {
    final baselines = {
      'Horror': [50, 120, 5.0],
      'Thriller': [55, 130, 3.5],
      'Drama': [35, 80, 2.5],
      'Comedy': [65, 140, 3.0],
      'Action': [110, 300, 2.2],
      'Sci-Fi': [90, 240, 2.0],
      'Romance': [45, 100, 4.0],
    };
    
    final b = baselines[genre] ?? [50, 100, 2.5];
    final mult = _getBudgetMult(budgetTier);
    
    return PrecisionForecast(
      domesticFloor: ((b[0] as int) * 0.5 * mult).round(),
      domesticCeiling: ((b[0] as int) * 1.5 * mult).round(),
      domesticMostLikely: ((b[0] as int) * mult).round(),
      worldwideFloor: ((b[1] as int) * 0.5 * mult).round(),
      worldwideCeiling: ((b[1] as int) * 1.5 * mult).round(),
      worldwideMostLikely: ((b[1] as int) * mult).round(),
      pessimisticROI: (b[2] as double) * 0.5,
      optimisticROI: (b[2] as double) * 1.8,
      expectedROI: b[2] as double,
      confidenceScore: 40,
      confidenceLevel: 'Low',
      confidenceFactors: ['Genre baseline only', 'Limited comparable data'],
      floorScenario: 'Underperformance scenario',
      ceilingScenario: 'Breakout potential',
      baselineScenario: 'Genre average performance',
      primaryComps: ['Genre baseline'],
      rationale: 'Based on $genre genre averages due to limited semantic matches',
      riskFactors: ['Untested concept space'],
      upsideDrivers: ['Fresh perspective potential'],
    );
  }
  
  // ═══════════════════════════════════════════════════════════════════════════
  // SCORING AND VERDICT
  // ═══════════════════════════════════════════════════════════════════════════
  
  int _calculateOverallScore(
    DeepNarrativeDNA dna,
    ExecutivePerspective exec,
    ZeitgeistAnalysis zeit,
    List<AdvancedComparableMatch> comps,
  ) {
    // Weighted scoring
    int score = 50;
    
    // Narrative strength (25%)
    score += ((dna.protagonistProfile.empathyScore * 0.15).round());
    score += ((dna.thematicAnalysis.thematicDepth * 0.10).round());
    
    // Structural integrity (15%)
    score += ((dna.structure.structuralIntegrity * 0.15).round());
    
    // Commercial potential (25%)
    score += ((dna.commercialDNA.wordOfMouthPotential * 0.15).round());
    score += (exec.greenFlags.length * 3);
    score -= (exec.redFlags.length * 2);
    
    // Cultural relevance (15%)
    score += ((zeit.socialRelevance * 0.10).round());
    
    // Comparable validation (20%)
    if (comps.isNotEmpty) {
      final avgMatch = comps.map((c) => c.overallMatchScore).reduce((a, b) => a + b) / comps.length;
      score += (avgMatch * 0.15).round();
    }
    
    return score.clamp(35, 98);
  }
  
  String _generateVerdict(int score) {
    if (score >= 85) return 'STRONG GREENLIGHT';
    if (score >= 75) return 'GREENLIGHT';
    if (score >= 65) return 'CAUTIOUS GREENLIGHT';
    if (score >= 55) return 'DEVELOPMENT NEEDED';
    if (score >= 45) return 'SIGNIFICANT REWORK';
    return 'PASS';
  }
  
  String _generateVerdictRationale(
    int score,
    DeepNarrativeDNA dna,
    ExecutivePerspective exec,
    ZeitgeistAnalysis zeit,
  ) {
    final strengths = <String>[];
    final concerns = <String>[];
    
    if (dna.protagonistProfile.empathyScore > 70) {
      strengths.add('compelling protagonist');
    }
    if (dna.thematicAnalysis.thematicDepth > 70) {
      strengths.add('thematic resonance');
    }
    if (dna.commercialDNA.wordOfMouthPotential > 70) {
      strengths.add('word-of-mouth potential');
    }
    if (zeit.socialRelevance > 70) {
      strengths.add('cultural timeliness');
    }
    
    if (exec.redFlags.isNotEmpty && exec.redFlags.first != 'None significant') {
      concerns.add(exec.redFlags.first.toLowerCase());
    }
    
    String rationale = '';
    if (strengths.isNotEmpty) {
      rationale = 'Strong ${strengths.join(", ")}';
    }
    if (concerns.isNotEmpty) {
      rationale += rationale.isEmpty ? 'Note: ${concerns.first}' : '. Address: ${concerns.first}';
    }
    
    return rationale.isEmpty ? 'Solid commercial and creative potential' : rationale;
  }
  
  // ═══════════════════════════════════════════════════════════════════════════
  // ADVANCED COMPARABLE DATABASE
  // ═══════════════════════════════════════════════════════════════════════════
  
  List<_CompEntry> _getAdvancedDatabase() {
    return [
      // Horror
      _CompEntry(
        title: 'Get Out', year: 2017, genre: 'Horror', platform: 'Theatrical',
        distributor: 'Universal/Blumhouse', budgetM: 5, domesticM: 176, worldwideM: 255,
        roi: 35.2, rtScore: 98, audienceScore: 86,
        archetype: 'The Truth Seeker', engine: 'Mystery/Revelation',
        protagonistType: 'The Everyman', arc: 'Positive change',
        theme: 'Identity', themes: ['Race', 'Class', 'Trust'],
        tones: ['satirical', 'tense', 'social'], primaryEmotion: 'Dread',
        marketTier: 'indie', quadrant: 'Four quadrant', pacing: 'Measured',
        marketLesson: 'Social commentary elevates genre',
        cautionaryNote: 'Requires deft handling of sensitive themes',
        successFactor: 'Fresh perspective on familiar horror tropes',
        performanceContext: 'Cultural conversation drove unprecedented word-of-mouth',
        audienceReaction: 'Audiences praised intelligent social commentary',
        legsPotential: 'Exceptional legs due to conversation-driving content',
      ),
      _CompEntry(
        title: 'A Quiet Place', year: 2018, genre: 'Horror', platform: 'Theatrical',
        distributor: 'Paramount', budgetM: 17, domesticM: 188, worldwideM: 340,
        roi: 11.0, rtScore: 96, audienceScore: 83,
        archetype: 'The Survival Crucible', engine: 'Survival/Pursuit',
        protagonistType: 'The Protector', arc: 'Testing arc',
        theme: 'Family', themes: ['Survival', 'Sacrifice', 'Parenthood'],
        tones: ['tense', 'emotional', 'intimate'], primaryEmotion: 'Fear',
        marketTier: 'mid', quadrant: 'Four quadrant', pacing: 'Slow-burn',
        marketLesson: 'High concept + family emotion = wide appeal',
        cautionaryNote: 'Gimmick must serve story, not dominate',
        successFactor: 'Emotional core beneath horror concept',
        performanceContext: 'Word-of-mouth from unique theatrical experience',
        audienceReaction: 'Audiences responded to family-centric horror',
        legsPotential: 'Strong legs from positive audience reactions',
      ),
      _CompEntry(
        title: 'Longlegs', year: 2024, genre: 'Horror', platform: 'Theatrical',
        distributor: 'Neon', budgetM: 10, domesticM: 74, worldwideM: 107,
        roi: 7.4, rtScore: 86, audienceScore: 65,
        archetype: 'The Truth Seeker', engine: 'Mystery/Revelation',
        protagonistType: 'The Seeker', arc: 'Positive change',
        theme: 'Evil', themes: ['Occult', 'Family trauma', 'Investigation'],
        tones: ['atmospheric', 'dread', 'mysterious'], primaryEmotion: 'Dread',
        marketTier: 'indie', quadrant: 'Adult', pacing: 'Slow-burn',
        marketLesson: 'Mystery marketing builds anticipation',
        cautionaryNote: 'Audience expectations from marketing must be met',
        successFactor: 'Viral marketing and Nicolas Cage performance',
        performanceContext: 'Marketing campaign created massive anticipation',
        audienceReaction: 'Divisive—some wanted more conventional horror',
        legsPotential: 'Front-loaded due to marketing hype',
      ),
      // Thriller
      _CompEntry(
        title: 'Gone Girl', year: 2014, genre: 'Thriller', platform: 'Theatrical',
        distributor: '20th Century Fox', budgetM: 61, domesticM: 167, worldwideM: 369,
        roi: 3.1, rtScore: 87, audienceScore: 79,
        archetype: 'The Truth Seeker', engine: 'Mystery/Revelation',
        protagonistType: 'The Antihero', arc: 'Revelation arc',
        theme: 'Marriage', themes: ['Deception', 'Media', 'Identity'],
        tones: ['dark', 'twisty', 'satirical'], primaryEmotion: 'Tension',
        marketTier: 'mid', quadrant: 'Four quadrant', pacing: 'Measured',
        marketLesson: 'Prestige thriller with book fanbase succeeds',
        cautionaryNote: 'Twist marketing is double-edged',
        successFactor: 'Rosamund Pike\'s transformative performance',
        performanceContext: 'Book adaptation with massive built-in audience',
        audienceReaction: 'Audiences thrilled by twists and performances',
        legsPotential: 'Strong legs from word-of-mouth about twist',
      ),
      _CompEntry(
        title: 'Knives Out', year: 2019, genre: 'Thriller', platform: 'Theatrical',
        distributor: 'Lionsgate', budgetM: 40, domesticM: 165, worldwideM: 311,
        roi: 4.1, rtScore: 97, audienceScore: 92,
        archetype: 'The Truth Seeker', engine: 'Mystery/Revelation',
        protagonistType: 'The Seeker', arc: 'Testing arc',
        theme: 'Class', themes: ['Family', 'Wealth', 'Truth'],
        tones: ['witty', 'fun', 'sharp'], primaryEmotion: 'Engagement',
        marketTier: 'mid', quadrant: 'Four quadrant', pacing: 'Fast',
        marketLesson: 'Original IP can compete with franchises',
        cautionaryNote: 'Ensemble requires careful balance',
        successFactor: 'Fresh take on classic whodunit with social edge',
        performanceContext: 'Thanksgiving release perfect for ensemble mystery',
        audienceReaction: 'Audiences loved fun, smart entertainment',
        legsPotential: 'Exceptional holiday legs',
      ),
      _CompEntry(
        title: 'Parasite', year: 2019, genre: 'Thriller', platform: 'Theatrical',
        distributor: 'Neon', budgetM: 11, domesticM: 53, worldwideM: 263,
        roi: 15.4, rtScore: 99, audienceScore: 90,
        archetype: 'The Power Corrupts Tale', engine: 'Ambition/Power',
        protagonistType: 'The Antihero', arc: 'Corruption arc',
        theme: 'Class', themes: ['Wealth', 'Family', 'Deception'],
        tones: ['dark', 'satirical', 'tense'], primaryEmotion: 'Tension',
        marketTier: 'indie', quadrant: 'Adult', pacing: 'Measured',
        marketLesson: 'Quality transcends language barriers',
        cautionaryNote: 'Tonal shifts require master execution',
        successFactor: 'Genre-defying brilliance with universal themes',
        performanceContext: 'Awards momentum built unprecedented crossover',
        audienceReaction: 'Audiences embraced challenging foreign film',
        legsPotential: 'Extraordinary legs from awards + word-of-mouth',
      ),
      // Drama
      _CompEntry(
        title: 'The Holdovers', year: 2023, genre: 'Drama', platform: 'Theatrical',
        distributor: 'Focus Features', budgetM: 13, domesticM: 36, worldwideM: 44,
        roi: 2.8, rtScore: 94, audienceScore: 89,
        archetype: 'The Redemption Arc', engine: 'Personal Transformation',
        protagonistType: 'The Sage', arc: 'Positive change',
        theme: 'Connection', themes: ['Loneliness', 'Found family', 'Healing'],
        tones: ['warm', 'witty', 'melancholic'], primaryEmotion: 'Empathy',
        marketTier: 'indie', quadrant: 'Adult', pacing: 'Measured',
        marketLesson: 'Character-driven drama finds audience in awards season',
        cautionaryNote: 'Requires patience-building marketing',
        successFactor: 'Authentic characters audiences fall in love with',
        performanceContext: 'Awards season platform release built momentum',
        audienceReaction: 'Audiences deeply moved by character journeys',
        legsPotential: 'Excellent legs from positive word-of-mouth',
      ),
      _CompEntry(
        title: 'Past Lives', year: 2023, genre: 'Drama', platform: 'Theatrical',
        distributor: 'A24', budgetM: 12, domesticM: 23, worldwideM: 46,
        roi: 2.9, rtScore: 95, audienceScore: 87,
        archetype: 'The Identity Crisis', engine: 'Emotional Connection',
        protagonistType: 'The Everyman', arc: 'Flat/testing arc',
        theme: 'Identity', themes: ['Love', 'Choice', 'Immigration'],
        tones: ['intimate', 'melancholic', 'tender'], primaryEmotion: 'Longing',
        marketTier: 'indie', quadrant: 'Female-skewing', pacing: 'Slow-burn',
        marketLesson: 'Quiet films can break through with critical support',
        cautionaryNote: 'Requires patience from audiences',
        successFactor: 'Universally relatable "what if" premise',
        performanceContext: 'Critical acclaim drove arthouse success',
        audienceReaction: 'Emotionally devastating in the best way',
        legsPotential: 'Strong legs from emotional word-of-mouth',
      ),
      _CompEntry(
        title: 'Oppenheimer', year: 2023, genre: 'Drama', platform: 'Theatrical',
        distributor: 'Universal', budgetM: 100, domesticM: 326, worldwideM: 952,
        roi: 5.5, rtScore: 93, audienceScore: 91,
        archetype: 'The Power Corrupts Tale', engine: 'Ambition/Power',
        protagonistType: 'The Sage', arc: 'Corruption arc',
        theme: 'Power', themes: ['Morality', 'Legacy', 'Science'],
        tones: ['intense', 'cerebral', 'epic'], primaryEmotion: 'Awe',
        marketTier: 'Tentpole', quadrant: 'Four quadrant', pacing: 'Epic',
        marketLesson: 'Adult drama can be event cinema',
        cautionaryNote: '3-hour runtime is risky',
        successFactor: 'Nolan brand + timely themes + Barbenheimer',
        performanceContext: 'Event cinema positioning with Barbie synergy',
        audienceReaction: 'Audiences embraced challenging prestige epic',
        legsPotential: 'Remarkable legs for 3-hour drama',
      ),
      _CompEntry(
        title: 'Challengers', year: 2024, genre: 'Drama', platform: 'Theatrical',
        distributor: 'Amazon MGM', budgetM: 55, domesticM: 46, worldwideM: 95,
        roi: 0.9, rtScore: 88, audienceScore: 72,
        archetype: 'The Love Against Odds', engine: 'Emotional Connection',
        protagonistType: 'Complex', arc: 'Testing arc',
        theme: 'Desire', themes: ['Competition', 'Love', 'Obsession'],
        tones: ['sensual', 'intense', 'stylish'], primaryEmotion: 'Tension',
        marketTier: 'mid', quadrant: 'Four quadrant', pacing: 'Fast',
        marketLesson: 'Director vision + star power creates event',
        cautionaryNote: 'Niche appeal despite star power',
        successFactor: 'Guadagnino\'s bold vision with Zendaya',
        performanceContext: 'Director-driven prestige with star power',
        audienceReaction: 'Divisive—loved for style, questioned for substance',
        legsPotential: 'Moderate—passionate fanbase but limited crossover',
      ),
      // Sci-Fi
      _CompEntry(
        title: 'Dune: Part Two', year: 2024, genre: 'Sci-Fi', platform: 'Theatrical',
        distributor: 'Warner Bros.', budgetM: 190, domesticM: 282, worldwideM: 711,
        roi: 2.7, rtScore: 92, audienceScore: 95,
        archetype: 'The Reluctant Hero\'s Journey', engine: 'Personal Transformation',
        protagonistType: 'The Chosen One', arc: 'Corruption arc',
        theme: 'Power', themes: ['Religion', 'Colonialism', 'Destiny'],
        tones: ['epic', 'intense', 'mythic'], primaryEmotion: 'Awe',
        marketTier: 'Tentpole', quadrant: 'Four quadrant', pacing: 'Epic',
        marketLesson: 'Sequel can massively overperform with quality',
        cautionaryNote: 'Requires first film success',
        successFactor: 'Elevated genre filmmaking delivered on promise',
        performanceContext: 'Built on Part One goodwill with superior execution',
        audienceReaction: 'Audiences thrilled by scale and craft',
        legsPotential: 'Excellent legs from repeat viewings',
      ),
      _CompEntry(
        title: 'Everything Everywhere All at Once', year: 2022, genre: 'Sci-Fi',
        platform: 'Theatrical', distributor: 'A24', budgetM: 25, domesticM: 77, worldwideM: 143,
        roi: 3.7, rtScore: 94, audienceScore: 89,
        archetype: 'The Identity Crisis', engine: 'Personal Transformation',
        protagonistType: 'The Everyman', arc: 'Positive change',
        theme: 'Family', themes: ['Identity', 'Purpose', 'Connection'],
        tones: ['chaotic', 'heartfelt', 'absurdist'], primaryEmotion: 'Wonder',
        marketTier: 'indie', quadrant: 'Four quadrant', pacing: 'Frenetic',
        marketLesson: 'Original vision can become cultural phenomenon',
        cautionaryNote: 'Extremely difficult to replicate',
        successFactor: 'Emotional core beneath multiverse madness',
        performanceContext: 'Word-of-mouth built slowly to phenomenon',
        audienceReaction: 'Audiences found unexpected emotional depth',
        legsPotential: 'Extraordinary legs—months of growth',
      ),
      // Comedy
      _CompEntry(
        title: 'Barbie', year: 2023, genre: 'Comedy', platform: 'Theatrical',
        distributor: 'Warner Bros.', budgetM: 145, domesticM: 636, worldwideM: 1446,
        roi: 5.5, rtScore: 88, audienceScore: 83,
        archetype: 'The Identity Crisis', engine: 'Personal Transformation',
        protagonistType: 'The Everyman', arc: 'Positive change',
        theme: 'Identity', themes: ['Feminism', 'Purpose', 'Authenticity'],
        tones: ['fun', 'satirical', 'heartfelt'], primaryEmotion: 'Joy',
        marketTier: 'Tentpole', quadrant: 'Four quadrant', pacing: 'Fast',
        marketLesson: 'IP + auteur vision = unprecedented success',
        cautionaryNote: 'Lightning in a bottle—hard to replicate',
        successFactor: 'Greta Gerwig\'s vision elevated IP',
        performanceContext: 'Cultural phenomenon + perfect marketing',
        audienceReaction: 'Audiences embraced cultural event',
        legsPotential: 'Record-breaking legs from repeat viewings',
      ),
      _CompEntry(
        title: 'Anyone But You', year: 2023, genre: 'Comedy', platform: 'Theatrical',
        distributor: 'Sony', budgetM: 25, domesticM: 91, worldwideM: 220,
        roi: 4.8, rtScore: 51, audienceScore: 86,
        archetype: 'The Love Against Odds', engine: 'Emotional Connection',
        protagonistType: 'The Everyman', arc: 'Positive change',
        theme: 'Love', themes: ['Romance', 'Comedy', 'Deception'],
        tones: ['fun', 'romantic', 'light'], primaryEmotion: 'Joy',
        marketTier: 'mid', quadrant: 'Female-skewing', pacing: 'Fast',
        marketLesson: 'Rom-coms can still work with right stars',
        cautionaryNote: 'Critical reception doesn\'t predict audience love',
        successFactor: 'Chemistry and star power over critical acclaim',
        performanceContext: 'Romantic comedy revival with Sydney Sweeney + Glen Powell',
        audienceReaction: 'Audiences hungry for theatrical rom-coms',
        legsPotential: 'Exceptional legs—grew week over week',
      ),
      // Action
      _CompEntry(
        title: 'John Wick: Chapter 4', year: 2023, genre: 'Action', platform: 'Theatrical',
        distributor: 'Lionsgate', budgetM: 100, domesticM: 187, worldwideM: 440,
        roi: 2.4, rtScore: 94, audienceScore: 94,
        archetype: 'The Revenge Odyssey', engine: 'Vengeance/Justice',
        protagonistType: 'The Antihero', arc: 'Testing arc',
        theme: 'Freedom', themes: ['Honor', 'Loyalty', 'Fate'],
        tones: ['intense', 'stylish', 'operatic'], primaryEmotion: 'Excitement',
        marketTier: 'Tentpole', quadrant: 'Male-skewing', pacing: 'Relentless',
        marketLesson: 'Quality sequels can be franchise peaks',
        cautionaryNote: 'Action fatigue is real',
        successFactor: 'Escalating set pieces with emotional stakes',
        performanceContext: 'Franchise built loyalty through consistent quality',
        audienceReaction: 'Audiences rewarded quality action filmmaking',
        legsPotential: 'Strong legs from positive reactions',
      ),
      _CompEntry(
        title: 'Top Gun: Maverick', year: 2022, genre: 'Action', platform: 'Theatrical',
        distributor: 'Paramount', budgetM: 170, domesticM: 718, worldwideM: 1489,
        roi: 4.8, rtScore: 96, audienceScore: 99,
        archetype: 'The Redemption Arc', engine: 'Personal Transformation',
        protagonistType: 'The Protector', arc: 'Positive change',
        theme: 'Legacy', themes: ['Mentorship', 'Mortality', 'Excellence'],
        tones: ['thrilling', 'emotional', 'nostalgic'], primaryEmotion: 'Excitement',
        marketTier: 'Tentpole', quadrant: 'Four quadrant', pacing: 'Fast',
        marketLesson: 'Nostalgia + quality = record-breaking',
        cautionaryNote: 'Requires original stars and long development',
        successFactor: 'Practical filmmaking + emotional depth',
        performanceContext: 'Post-pandemic theatrical event + Tom Cruise',
        audienceReaction: 'Audiences fell in love—all quadrants',
        legsPotential: 'Historic legs—played for months',
      ),
    ];
  }
}

// Internal comparable entry
class _CompEntry {
  final String title;
  final int year;
  final String genre;
  final String platform;
  final String distributor;
  final int? budgetM;
  final int? domesticM;
  final int? worldwideM;
  final double? roi;
  final int? rtScore;
  final int? audienceScore;
  
  final String archetype;
  final String engine;
  final String protagonistType;
  final String arc;
  final String theme;
  final List<String> themes;
  final List<String> tones;
  final String primaryEmotion;
  final String marketTier;
  final String quadrant;
  final String pacing;
  
  final String marketLesson;
  final String cautionaryNote;
  final String successFactor;
  final String performanceContext;
  final String audienceReaction;
  final String legsPotential;
  
  _CompEntry({
    required this.title,
    required this.year,
    required this.genre,
    required this.platform,
    required this.distributor,
    this.budgetM,
    this.domesticM,
    this.worldwideM,
    this.roi,
    this.rtScore,
    this.audienceScore,
    required this.archetype,
    required this.engine,
    required this.protagonistType,
    required this.arc,
    required this.theme,
    required this.themes,
    required this.tones,
    required this.primaryEmotion,
    required this.marketTier,
    required this.quadrant,
    required this.pacing,
    required this.marketLesson,
    required this.cautionaryNote,
    required this.successFactor,
    required this.performanceContext,
    required this.audienceReaction,
    required this.legsPotential,
  });
}
